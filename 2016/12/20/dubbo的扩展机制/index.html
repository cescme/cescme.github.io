<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>dubbo的扩展机制 | cescme</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">dubbo的扩展机制</h1><a id="logo" href="/.">cescme</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">dubbo的扩展机制</h1><div class="post-meta">Dec 20, 2016<span> | </span><span class="category"><a href="/categories/框架/">框架</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/12/20/dubbo的扩展机制/" href="/2016/12/20/dubbo的扩展机制/#comments" class="ds-thread-count"></a><div class="post-content"><p>dubbo被广泛接纳的其中的一个重要原因就是其强大灵活的扩展机制，开发者可自定义插件嵌入dubbo，实现灵活的业务需求。扩展机制的实现是利用了SPI规范，SPI规定了实现的基本原理，但不提供具体实现。dubbo利用SPI注解自己实现了一套SPI的插件加载机制，这其中主要是由ExtensionLoader扩展加载器完成的，本文就其中的实现机制进行简述。</p>
<h3 id="ExtensionLoader初始化"><a href="#ExtensionLoader初始化" class="headerlink" title="ExtensionLoader初始化"></a>ExtensionLoader初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.type = type;</div><div class="line">    objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ExtensionLoader充当插件工厂角色，提供了一个私有的构造器。其入参type为扩展接口类型。dubbo通过SPI注解定义了可扩展的接口，如Filter、Transporter等。每个类型的扩展对应一个ExtensionLoader。SPI的value参数决定了默认的扩展实现。</p>
<p>当扩展类型是ExtensionFactory时，不指定objectFactory，否则初始化ExtensionFactory的ExtensionLoader并获取一个扩展适配器。扩展适配器将在下文讲述。</p>
<h3 id="配置文件扫描"><a href="#配置文件扫描" class="headerlink" title="配置文件扫描"></a>配置文件扫描</h3><p>dubbo默认依次扫描META-INF/dubbo/internal/、META-INF/dubbo/、META-INF/services/三个classpath目录下的配置文件。配置文件以具体扩展接口全名命名，如com.alibaba.dubbo.rpc.Filter，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">echo=com.alibaba.dubbo.rpc.filter.EchoFilter</div><div class="line">generic=com.alibaba.dubbo.rpc.filter.GenericFilter</div><div class="line">genericimpl=com.alibaba.dubbo.rpc.filter.GenericImplFilter</div><div class="line">token=com.alibaba.dubbo.rpc.filter.TokenFilter</div><div class="line">accesslog=com.alibaba.dubbo.rpc.filter.AccessLogFilter</div><div class="line">activelimit=com.alibaba.dubbo.rpc.filter.ActiveLimitFilter</div><div class="line">classloader=com.alibaba.dubbo.rpc.filter.ClassLoaderFilter</div><div class="line">context=com.alibaba.dubbo.rpc.filter.ContextFilter</div><div class="line">consumercontext=com.alibaba.dubbo.rpc.filter.ConsumerContextFilter</div><div class="line">exception=com.alibaba.dubbo.rpc.filter.ExceptionFilter</div><div class="line">executelimit=com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter</div><div class="line">deprecated=com.alibaba.dubbo.rpc.filter.DeprecatedFilter</div><div class="line">compatible=com.alibaba.dubbo.rpc.filter.CompatibleFilter</div><div class="line">timeout=com.alibaba.dubbo.rpc.filter.TimeoutFilter</div><div class="line">monitor=com.alibaba.dubbo.monitor.support.MonitorFilter</div><div class="line">validation=com.alibaba.dubbo.validation.filter.ValidationFilter</div><div class="line">cache=com.alibaba.dubbo.cache.filter.CacheFilter</div><div class="line">trace=com.alibaba.dubbo.rpc.protocol.dubbo.filter.TraceFilter</div><div class="line">future=com.alibaba.dubbo.rpc.protocol.dubbo.filter.FutureFilter</div></pre></td></tr></table></figure>
<p>等号前为扩展名，其后为扩展实现类全路径名。<br>ExtensionLoader中loadFile方法加载配置文件。<br>1.逐行读取配置文件，提取出扩展名或扩展类路径<br>2.利用Class.forName方法进行类加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; clazz = Class.forName(line, <span class="keyword">true</span>, classLoader);</div></pre></td></tr></table></figure>
<p>3.处理Adaptive注解，若存在则将该实现类保存至cachedAdaptiveClass属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</div><div class="line">    <span class="keyword">if</span>(cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</div><div class="line">        cachedAdaptiveClass = clazz;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! cachedAdaptiveClass.equals(clazz)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"More than 1 adaptive class found:"</span>    + cachedAdaptiveClass.getClass().getName()</div><div class="line">                + <span class="string">", "</span> + clazz.getClass().getName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.尝试获取参数类型为当前扩展类型的构造器方法，若成功则表明存在该扩展的封装类型，将封装类型存入wrappers集合；否则转入第五步</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    clazz.getConstructor(type); <span class="comment">// 扩展类型参数的构造器是封装器的约定特征，目前dubbo中默认的只有Filter和Listener的封装器</span></div><div class="line">    Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</div><div class="line">    <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</div><div class="line">        cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        wrappers = cachedWrapperClasses;</div><div class="line">    &#125;</div><div class="line">    wrappers.add(clazz);</div><div class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">    <span class="comment">// 第五步</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.处理active注解，将扩展名对应active注解存入cachedActivates</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Activate activate = clazz.getAnnotation(Activate.class);</div><div class="line"><span class="keyword">if</span> (activate != <span class="keyword">null</span>) &#123;</div><div class="line">    cachedActivates.put(names[<span class="number">0</span>], activate);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="扩展适配器"><a href="#扩展适配器" class="headerlink" title="扩展适配器"></a>扩展适配器</h3><p>在dubbo扩展中，适配器模式被广泛使用，其作用在于为同一扩展类型下的多个扩展实现的调用提供路由功能，如指定优先级等。dubbo提供了两种方式来生成扩展适配器：</p>
<p>1.静态扩展<br>所谓的静态扩展就是提前通过编码的形式确定扩展的具体实现，且该实现类由Adaptive注解标注，如AdaptiveCompiler。在加载配置文件的loadFile方法中，已经描述过处理该类型扩展的逻辑。</p>
<p>2.动态扩展<br>动态扩展即通过动态代理生成扩展类的动态代理类，在dubbo中是通过javassist技术生成的。与传统的jdk动态代理、cglib不同，javassist提供封装后的API对字节码进行间接操作，简单易用，不关心具体字节码，灵活性更高，且处理效率也较高，是dubbo默认的编译器。</p>
<p>首先，ExtensionLoader会调用createAdaptiveExtensionClassCode方法为当前扩展类型生成适配器的源码，其处理要点如下：</p>
<ul>
<li>检查是否至少有一个方法有Adaptive注解，若不存在则抛出异常，即要完成动态代理，必须有方法标注了Adaptive注解</li>
<li>对于有Adaptive注解的方法，判断其入参中是否有URL类型的参数，或者复杂参数中是否有URL类型的属性，若没有则抛出异常。这里体现出了为什么dubbo要提供动态适配器生成机制。dubbo中的URL总线提供了服务的全部信息，而开发者可以定义差异化的服务配置，因此生成的URL差异化也较大，若全部靠用户硬编码静态适配器的话效率太低。有了动态代理，dubbo可以根据URL参数动态地生成适配器的适配逻辑，确定扩展实现的获取优先级。因此，URL作为参数直接或间接传入是必须的，否则失去了动态生成的凭据。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> urlTypeIndex = -<span class="number">1</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</div><div class="line">    <span class="keyword">if</span> (pts[i].equals(URL.class)) &#123;</div><div class="line">        urlTypeIndex = i;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 有类型为URL的参数</span></div><div class="line"><span class="keyword">if</span> (urlTypeIndex != -<span class="number">1</span>) &#123;</div><div class="line">    <span class="comment">// Null Point check</span></div><div class="line">    String s = String.format(<span class="string">"\nif (arg%d == null) throw new IllegalArgumentException(\"url == null\");"</span>,</div><div class="line">                    urlTypeIndex);</div><div class="line">    code.append(s);</div><div class="line">    </div><div class="line">    s = String.format(<span class="string">"\n%s url = arg%d;"</span>, URL.class.getName(), urlTypeIndex); </div><div class="line">    code.append(s);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 参数没有URL类型</span></div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">    String attribMethod = <span class="keyword">null</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 找到参数的URL属性</span></div><div class="line">    LBL_PTS:</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</div><div class="line">        Method[] ms = pts[i].getMethods();</div><div class="line">        <span class="keyword">for</span> (Method m : ms) &#123;</div><div class="line">            String name = m.getName();</div><div class="line">            <span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.length() &gt; <span class="number">3</span>)</div><div class="line">                    &amp;&amp; Modifier.isPublic(m.getModifiers())</div><div class="line">                    &amp;&amp; !Modifier.isStatic(m.getModifiers())</div><div class="line">                    &amp;&amp; m.getParameterTypes().length == <span class="number">0</span></div><div class="line">                    &amp;&amp; m.getReturnType() == URL.class) &#123;</div><div class="line">                urlTypeIndex = i;</div><div class="line">                attribMethod = name;</div><div class="line">                <span class="keyword">break</span> LBL_PTS;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(attribMethod == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adative class for interface "</span> + type.getName()</div><div class="line">                + <span class="string">": not found url parameter or url attribute in parameters of method "</span> + method.getName());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 后续处理...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>对于无Adaptive注解的方法，调用时直接抛出异常</li>
<li>根据adaptive注解的value数组值，及SPI注解定义的默认扩展名，确定适配逻辑，即扩展获取的优先级，这里不再罗列代码，下面为一个具体生成的适配器源码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.remoting;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.ExtensionLoader;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transporter</span>$<span class="title">Adpative</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">remoting</span>.<span class="title">Transporter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> com.alibaba.dubbo.remoting.<span class="function">Client <span class="title">connect</span><span class="params">(com.alibaba.dubbo.common.URL arg0, com.alibaba.dubbo.remoting.ChannelHandler arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.common.URL </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</div><div class="line">        com.alibaba.dubbo.common.URL url = arg0;</div><div class="line">        String extName = url.getParameter(<span class="string">"client"</span>, url.getParameter(<span class="string">"transporter"</span>, <span class="string">"netty"</span>)); <span class="comment">// 处理顺序</span></div><div class="line">        <span class="keyword">if</span>(extName == <span class="keyword">null</span>) </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.remoting.Transporter) name from url("</span> + url.toString() + <span class="string">") use keys([client, transporter])"</span>);</div><div class="line">        com.alibaba.dubbo.remoting.Transporter extension = (com.alibaba.dubbo.remoting.Transporter)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.remoting.Transporter.class).getExtension(extName);</div><div class="line">        <span class="keyword">return</span> extension.connect(arg0, arg1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> com.alibaba.dubbo.remoting.<span class="function">Server <span class="title">bind</span><span class="params">(com.alibaba.dubbo.common.URL arg0, com.alibaba.dubbo.remoting.ChannelHandler arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.common.URL </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</div><div class="line">        com.alibaba.dubbo.common.URL url = arg0;</div><div class="line">        String extName = url.getParameter(<span class="string">"server"</span>, url.getParameter(<span class="string">"transporter"</span>, <span class="string">"netty"</span>)); <span class="comment">// 处理顺序</span></div><div class="line">        <span class="keyword">if</span>(extName == <span class="keyword">null</span>) </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fail to get extension(com.alibaba.dubbo.remoting.Transporter) name from url("</span> + url.toString() + <span class="string">") use keys([server, transporter])"</span>);</div><div class="line">        com.alibaba.dubbo.remoting.Transporter extension = (com.alibaba.dubbo.remoting.Transporter)ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.remoting.Transporter.class).getExtension(extName);</div><div class="line">        <span class="keyword">return</span> extension.bind(arg0, arg1);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，核心逻辑是获取扩展名extName，以bind方法为例，其获取优先级是server，transporter，netty，可参见URL的getParameter方法源码。其中netty是Transporter接口的SPI注解确定的默认值，而server和transporter是bind方法的Adaptive注解定义的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SPI</span>(<span class="string">"netty"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transporter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.SERVER_KEY, Constants.TRANSPORTER_KEY&#125;)</div><div class="line">    <span class="function">Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Adaptive</span>(&#123;Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY&#125;)</div><div class="line">    <span class="function">Client <span class="title">connect</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>拿到扩展名后，再从ExtensionLoader获取到扩展实例，调用具体的bind方法。</p>
<p>源码生成后，ExtensionLoader再调用默认的JavassitCompiler进行编译和类加载，其具体实现原理不在本文讨论范围，有机会的话后续会介绍这部分内容。</p>
<p>ExtensionLoader提供了获取扩展适配器的方法，优先查看是否有静态适配器，否则会使用动态适配器。</p>
<h3 id="封装类"><a href="#封装类" class="headerlink" title="封装类"></a>封装类</h3><p>dubbo中存在一种对于扩展的封装类，其功能是将各扩展实例串联起来，形成扩展链，比如过滤器链，监听链。当调用ExtensionLoader的getExtension方法时，会做拦截处理，如果存在封装器，则返回封装器实现，而将真实实现通过构造方法注入到封装器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">T instance = (T) EXTENSION_INSTANCES.get(clazz);</div><div class="line"><span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">    EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());</div><div class="line">    instance = (T) EXTENSION_INSTANCES.get(clazz);</div><div class="line">&#125;</div><div class="line">injectExtension(instance);</div><div class="line">Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</div><div class="line"><span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; wrapperClasses.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</div><div class="line">        instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至于封装器是怎样组织起调用链的，可以参见<a href="https://cescme.github.io/2016/12/02/dubbo%20filter%E9%93%BE%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91/" target="_blank" rel="external">dubbo filter链实现逻辑</a></p>
<p>这里有个injectExtension方法，其作用是：如果当前扩展实例存在其他的扩展属性，则通过反射调用其set方法设置扩展属性。该扩展属性是适配器类型，也是通过ExtensionLoader获取的。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>ExtensionLoader作为一个IOC插件容器，为dubbo的插件体系运作提供了保障，可以说是dubbo中的核心。掌握了其基本原理，才有助于我们更好地分析dubbo源码。后续的dubbo源码分析中也会以此为基础展开介绍。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.1" async></script><a data-url="http://yoursite.com/2016/12/20/dubbo的扩展机制/" data-id="cix666dfl000164rvth9itssw" class="article-share-link">分享到</a><div class="tags"><a href="/tags/dubbo/">dubbo</a></div><div class="post-nav"><a href="/2016/12/21/记一次使用redis发布订阅遇到的坑/" class="pre">记一次使用redis发布订阅遇到的坑</a><a href="/2016/12/19/dubbo应用配置logback日志/" class="next">dubbo应用配置logback日志</a></div><div data-thread-key="2016/12/20/dubbo的扩展机制/" data-title="dubbo的扩展机制" data-url="http://yoursite.com/2016/12/20/dubbo的扩展机制/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/12/20/dubbo的扩展机制/" data-title="dubbo的扩展机制" data-url="http://yoursite.com/2016/12/20/dubbo的扩展机制/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发编程/">并发编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/tbschedule/" style="font-size: 15px;">tbschedule</a> <a href="/tags/CAS/" style="font-size: 15px;">CAS</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/DUBBO/" style="font-size: 15px;">DUBBO</a> <a href="/tags/装饰器模式/" style="font-size: 15px;">装饰器模式</a> <a href="/tags/日志/" style="font-size: 15px;">日志</a> <a href="/tags/金额/" style="font-size: 15px;">金额</a> <a href="/tags/sublime/" style="font-size: 15px;">sublime</a> <a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/定时调度/" style="font-size: 15px;">定时调度</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/微信/" style="font-size: 15px;">微信</a> <a href="/tags/Auth2/" style="font-size: 15px;">Auth2</a> <a href="/tags/贝叶斯分类器/" style="font-size: 15px;">贝叶斯分类器</a> <a href="/tags/短信识别/" style="font-size: 15px;">短信识别</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/26/对金额占比展示的巧妙处理方案/">对金额占比展示的巧妙处理方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/记一次使用redis发布订阅遇到的坑/">记一次使用redis发布订阅遇到的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/dubbo的扩展机制/">dubbo的扩展机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/19/dubbo应用配置logback日志/">dubbo应用配置logback日志</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/10/利用hexo搭建个人博客/">利用hexo搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/08/微信网页授权登录流程实现方案/">微信网页授权登录流程实现方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/06/CAS原理应用于配置信息懒加载/">CAS原理应用于配置信息懒加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/02/dubbo filter链实现逻辑/">dubbo filter链实现逻辑</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/01/朴素贝叶斯分类器应用于短信识别/">贝叶斯分类器应用于短信识别</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/tbschedule定时任务框架使用简述/">tbschedule定时任务框架使用简述</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/cescme" title="我的github" target="_blank">我的github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">cescme.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.1"><script>var duoshuoQuery = {short_name:'cescme'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>